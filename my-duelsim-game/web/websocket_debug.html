<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #log {
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
            font-family: monospace;
        }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        button {
            padding: 5px 10px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <h1>WebSocket Debug</h1>
    
    <div>
        <button id="connect">Connect</button>
        <button id="disconnect" disabled>Disconnect</button>
        <input type="text" id="port" value="5556" size="5"> Port
    </div>
    
    <div id="log"></div>
    
    <div>
        <input type="text" id="message" placeholder="Message to send" style="width: 300px;">
        <button id="send" disabled>Send</button>
    </div>
    
    <script>
        const connectBtn = document.getElementById('connect');
        const disconnectBtn = document.getElementById('disconnect');
        const sendBtn = document.getElementById('send');
        const portInput = document.getElementById('port');
        const messageInput = document.getElementById('message');
        const logDiv = document.getElementById('log');
        
        let socket = null;
        let reconnectTimer = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function connect() {
            const port = portInput.value || '5556';
            
            try {
                log(`Connecting to ws://${window.location.hostname}:${port}...`);
                socket = new WebSocket(`ws://${window.location.hostname}:${port}`);
                
                socket.onopen = () => {
                    log('Connected!', 'success');
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    sendBtn.disabled = false;
                    reconnectAttempts = 0;
                };
                
                socket.onclose = (event) => {
                    log(`Disconnected (code: ${event.code}, reason: ${event.reason || 'none'})`, 'error');
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    sendBtn.disabled = true;
                    socket = null;
                    
                    // Auto-reconnect if not manually disconnected
                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        reconnectAttempts++;
                        const delay = 3000 * Math.min(reconnectAttempts, 3);
                        log(`Attempting to reconnect in ${delay/1000} seconds... (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
                        reconnectTimer = setTimeout(connect, delay);
                    }
                };
                
                socket.onerror = (error) => {
                    log(`Error: ${error.message || 'Unknown error'}`, 'error');
                };
                
                socket.onmessage = (event) => {
                    try {
                        // Try to parse as JSON
                        const data = JSON.parse(event.data);
                        log(`Received: ${JSON.stringify(data, null, 2)}`, 'info');
                    } catch (e) {
                        // Not JSON, show as plain text
                        log(`Received: ${event.data}`, 'info');
                    }
                };
            } catch (e) {
                log(`Connection error: ${e.message}`, 'error');
            }
        }
        
        function disconnect() {
            if (!socket) return;
            
            clearTimeout(reconnectTimer);
            reconnectAttempts = MAX_RECONNECT_ATTEMPTS; // Prevent auto-reconnect
            
            log('Disconnecting...');
            socket.close();
        }
        
        function sendMessage() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                log('Not connected!', 'error');
                return;
            }
            
            const message = messageInput.value;
            if (!message) return;
            
            try {
                socket.send(message);
                log(`Sent: ${message}`);
                messageInput.value = '';
            } catch (e) {
                log(`Send error: ${e.message}`, 'error');
            }
        }
        
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        sendBtn.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html> 