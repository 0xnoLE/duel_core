<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DuelSim: Tick-Based Combat Engine</title>
  <style>
    body {
      font-family: monospace;
      background-color: #111;
      color: #0f0;
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }
    #log {
      border: 1px solid #0f0;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      background: #000;
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-weight: bold;
      cursor: pointer;
      background-color: #222;
      color: #0f0;
      border: 1px solid #0f0;
    }
    button:hover {
      background-color: #333;
    }
    .controls {
      margin-bottom: 20px;
    }
    .arena {
      display: grid;
      grid-template-columns: repeat(5, 50px);
      grid-template-rows: repeat(5, 50px);
      gap: 2px;
      margin-bottom: 20px;
    }
    .cell {
      width: 50px;
      height: 50px;
      background-color: #222;
      border: 1px solid #444;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .player-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .player-card {
      border: 1px solid #0f0;
      padding: 10px;
      width: 45%;
      background-color: #000;
    }
    .hp-bar {
      height: 20px;
      background-color: #222;
      margin-top: 5px;
    }
    .hp-fill {
      height: 100%;
      background-color: #0f0;
      transition: width 0.3s;
    }
    .cooldown {
      height: 5px;
      background-color: #222;
      margin-top: 5px;
    }
    .cooldown-fill {
      height: 100%;
      background-color: #f00;
      transition: width 0.3s;
    }
    .auto-tick {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
    .auto-tick label {
      margin-right: 10px;
    }
  </style>
</head>
<body>

  <h1>DuelSim: Tick-Based Combat Engine</h1>
  
  <div class="controls">
    <button id="startDuel">Start New Duel</button>
    <button id="runTick">Run Tick</button>
    <div class="auto-tick">
      <label for="autoTick">Auto-tick:</label>
      <input type="checkbox" id="autoTick">
      <label for="tickSpeed">Speed (ms):</label>
      <input type="number" id="tickSpeed" value="600" min="100" max="2000" step="100">
    </div>
  </div>

  <div class="player-stats">
    <div class="player-card" id="player1Card">
      <h3>Fighter1</h3>
      <div>HP: <span id="player1HP">99</span>/99</div>
      <div class="hp-bar"><div class="hp-fill" id="player1HPBar" style="width: 100%"></div></div>
      <div>Cooldown: <span id="player1Cooldown">0</span></div>
      <div class="cooldown"><div class="cooldown-fill" id="player1CooldownBar" style="width: 0%"></div></div>
      <div>Position: <span id="player1Pos">(0,0)</span></div>
    </div>
    
    <div class="player-card" id="player2Card">
      <h3>Fighter2</h3>
      <div>HP: <span id="player2HP">99</span>/99</div>
      <div class="hp-bar"><div class="hp-fill" id="player2HPBar" style="width: 100%"></div></div>
      <div>Cooldown: <span id="player2Cooldown">0</span></div>
      <div class="cooldown"><div class="cooldown-fill" id="player2CooldownBar" style="width: 0%"></div></div>
      <div>Position: <span id="player2Pos">(4,4)</span></div>
    </div>
  </div>

  <h2>Arena</h2>
  <div class="arena" id="arena">
    <!-- Grid cells will be generated by JavaScript -->
  </div>

  <h2>Combat Log</h2>
  <div id="log"></div>

  <script>
    // DOM elements
    const startDuelBtn = document.getElementById('startDuel');
    const runTickBtn = document.getElementById('runTick');
    const autoTickCheckbox = document.getElementById('autoTick');
    const tickSpeedInput = document.getElementById('tickSpeed');
    const logElement = document.getElementById('log');
    const arenaElement = document.getElementById('arena');
    
    // Player stats elements
    const player1HP = document.getElementById('player1HP');
    const player1HPBar = document.getElementById('player1HPBar');
    const player1Cooldown = document.getElementById('player1Cooldown');
    const player1CooldownBar = document.getElementById('player1CooldownBar');
    const player1Pos = document.getElementById('player1Pos');
    
    const player2HP = document.getElementById('player2HP');
    const player2HPBar = document.getElementById('player2HPBar');
    const player2Cooldown = document.getElementById('player2Cooldown');
    const player2CooldownBar = document.getElementById('player2CooldownBar');
    const player2Pos = document.getElementById('player2Pos');
    
    // State
    let autoTickInterval = null;
    let currentTick = 0;
    
    // Initialize arena grid
    function initArena() {
      arenaElement.innerHTML = '';
      for (let y = 0; y < 5; y++) {
        for (let x = 0; x < 5; x++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.id = `cell-${x}-${y}`;
          arenaElement.appendChild(cell);
        }
      }
    }
    
    // Update arena with player positions
    function updateArena(player1Pos, player2Pos) {
      // Clear all cells
      document.querySelectorAll('.cell').forEach(cell => {
        cell.textContent = '';
      });
      
      // Set player positions
      const [x1, y1] = player1Pos;
      const [x2, y2] = player2Pos;
      
      const cell1 = document.getElementById(`cell-${x1}-${y1}`);
      if (cell1) cell1.textContent = '1';
      
      const cell2 = document.getElementById(`cell-${x2}-${y2}`);
      if (cell2) cell2.textContent = '2';
    }
    
    // Update player stats
    function updatePlayerStats(player1Data, player2Data) {
      // Player 1
      player1HP.textContent = player1Data.hp;
      player1HPBar.style.width = `${(player1Data.hp / 99) * 100}%`;
      player1Cooldown.textContent = player1Data.cooldown;
      player1CooldownBar.style.width = `${(player1Data.cooldown / 4) * 100}%`;
      player1Pos.textContent = `(${player1Data.position[0]},${player1Data.position[1]})`;
      
      // Player 2
      player2HP.textContent = player2Data.hp;
      player2HPBar.style.width = `${(player2Data.hp / 99) * 100}%`;
      player2Cooldown.textContent = player2Data.cooldown;
      player2CooldownBar.style.width = `${(player2Data.cooldown / 4) * 100}%`;
      player2Pos.textContent = `(${player2Data.position[0]},${player2Data.position[1]})`;
      
      // Update arena
      updateArena(player1Data.position, player2Data.position);
    }
    
    // Log a message
    function log(msg) {
      logElement.innerHTML += msg + "<br/>";
      logElement.scrollTop = logElement.scrollHeight;
    }
    
    // API calls
    async function initDuel() {
      try {
        const res = await fetch("http://localhost:5555/start-duel", { method: "POST" });
        const text = await res.text();
        log(`[INIT] ${text}`);
        currentTick = 0;
        
        // Get initial status
        await getStatus();
      } catch (error) {
        log(`[ERROR] Failed to initialize duel: ${error.message}`);
      }
    }
    
    async function runTick() {
      try {
        const res = await fetch("http://localhost:5555/tick");
        const data = await res.json();
        
        // Update current tick
        currentTick = data.tick;
        
        // Log events
        if (data.events && data.events.length > 0) {
          data.events.forEach(event => {
            log(`[TICK ${currentTick}] ${event}`);
          });
        } else {
          log(`[TICK ${currentTick}] No events`);
        }
        
        // Update player stats
        updatePlayerStats(data.player1, data.player2);
        
        // Check if duel is over
        if (!data.active) {
          log(`[DUEL OVER] Duel ended at tick ${currentTick}`);
          stopAutoTick();
          runTickBtn.disabled = true;
        }
        
        return data.active;
      } catch (error) {
        log(`[ERROR] Failed to run tick: ${error.message}`);
        return false;
      }
    }
    
    async function getStatus() {
      try {
        const res = await fetch("http://localhost:5555/status");
        const data = await res.json();
        
        if (data.active) {
          // Update current tick
          currentTick = data.tick;
          
          // Update player stats
          updatePlayerStats(data.player1, data.player2);
          
          runTickBtn.disabled = false;
        } else {
          runTickBtn.disabled = true;
        }
      } catch (error) {
        log(`[ERROR] Failed to get status: ${error.message}`);
      }
    }
    
    // Auto-tick functionality
    function startAutoTick() {
      if (autoTickInterval) return;
      
      const tickSpeed = parseInt(tickSpeedInput.value);
      autoTickInterval = setInterval(async () => {
        const active = await runTick();
        if (!active) {
          stopAutoTick();
        }
      }, tickSpeed);
      
      log(`[AUTO] Auto-tick started (${tickSpeed}ms)`);
    }
    
    function stopAutoTick() {
      if (autoTickInterval) {
        clearInterval(autoTickInterval);
        autoTickInterval = null;
        autoTickCheckbox.checked = false;
        log(`[AUTO] Auto-tick stopped`);
      }
    }
    
    // Event listeners
    startDuelBtn.addEventListener('click', async () => {
      stopAutoTick();
      await initDuel();
      runTickBtn.disabled = false;
    });
    
    runTickBtn.addEventListener('click', runTick);
    
    autoTickCheckbox.addEventListener('change', () => {
      if (autoTickCheckbox.checked) {
        startAutoTick();
      } else {
        stopAutoTick();
      }
    });
    
    tickSpeedInput.addEventListener('change', () => {
      if (autoTickInterval) {
        stopAutoTick();
        startAutoTick();
      }
    });
    
    // Initialize
    initArena();
    getStatus();
  </script>

</body>
</html>
